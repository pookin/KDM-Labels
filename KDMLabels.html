<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KDM Label Printer</title>
  <style>
    /* Base Mobile Styles */
    body { 
      margin: 0; 
      /* padding: 10px; Replaced by padding-top and padding-bottom */
      font-family: Arial, sans-serif; 
      background: #2c3e50; 
      color: #ecf0f1; 
      font-size: 16px; /* Base font size for mobile */
      padding-top: 50px; /* For fixed header */
      padding-bottom: 50px; /* For fixed footer */
    }

    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #1c2b3a; /* Darker header background */
      color: #ecf0f1;
      padding: 10px 20px;
      box-sizing: border-box;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 50px; /* Fixed height */
    }
    .fixed-header h1 {
      margin: 0;
      font-size: 1.2em;
    }
    #hamburgerMenuBtn {
      background: none;
      border: none;
      color: #ecf0f1;
      font-size: 1.8em; /* Larger hamburger icon */
      cursor: pointer;
    }

    #mainMenu {
      position: fixed;
      top: 0; 
      left: -280px; /* Start off-screen */
      width: 250px;
      height: 100%;
      background: #34495e;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
      z-index: 1001; 
      transition: left 0.3s ease;
      color: #ecf0f1;
      /* display: none; will be controlled by JS by toggling a class or style.left */
    }
    #mainMenu h3 {
      margin-top: 0;
      color: #ecf0f1;
      border-bottom: 1px solid #4a6fa5;
      padding-bottom: 10px;
    }
    #mainMenu a, #mainMenu button.menu-item { /* Added button.menu-item for non-link items */
      display: block;
      color: #ecf0f1;
      text-decoration: none;
      padding: 10px 0;
      border-bottom: 1px solid #4a6fa5;
      background: none;
      border-left: none;
      border-right: none;
      border-top: none;
      width: 100%;
      text-align: left;
      font-size: 1em;
      cursor: pointer;
    }
    #mainMenu a:hover, #mainMenu button.menu-item:hover {
      background-color: #4a6fa5;
    }
    #mainMenu .close-menu-btn {
        display: block;
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.5em;
        background: none;
        border: none;
        color: #ecf0f1;
        cursor: pointer;
    }

    .dialog-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.7);
      z-index: 1002; /* Above overlay */
      width: 90%;
      max-width: 500px; /* Max width for modals */
      box-sizing: border-box;
      display: none; /* Initially hidden */
    }
    .dialog-modal h3 {
      margin-top: 0;
      border-bottom: 1px solid #4a6fa5;
      padding-bottom: 10px;
      color: #ecf0f1; /* Ensure heading color */
    }
    .dialog-modal .close-dialog-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.8em;
      background: none;
      border: none;
      color: #ecf0f1;
      cursor: pointer;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6); /* Semi-transparent black */
      z-index: 1001; /* Below modals, above content */
      display: none; /* Initially hidden */
    }

    .fixed-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #1c2b3a; /* Darker footer background */
      padding: 10px 0; /* Centered content */
      box-sizing: border-box;
      z-index: 1000;
      display: flex;
      justify-content: center; /* Center button(s) */
      align-items: center;
      height: 50px; /* Fixed height */
    }
    .fixed-footer .btn {
       width: auto; /* Allow button to size based on content */
       padding: 10px 20px; /* Adjust padding as needed */
    }

    /* Styles for the content that will be moved from #settings */
    .settings-content-area {
      background: #4a6fa5; /* Copied from .settings */
      padding: 15px; /* Copied from .settings */
      border-radius: 6px; /* Copied from .settings */
      /* margin-bottom: 20px; /* Copied from .settings - adjust as needed in dialog */
      margin-top: 15px; /* Add some space below dialog title */
    }
    .settings-content-area label { 
      display: block; /* Labels on their own line */
      width: auto; /* Auto width */
      margin-bottom: 8px; /* Space below label */
    }
    .settings-content-area input[type="number"] { 
      margin-right: 5px; 
      margin-bottom: 10px; 
      padding: 8px; /* Increased padding */
      border-radius: 4px; 
      border: 1px solid #5d8aa8; 
      background: #2c3e50; 
      color: #ecf0f1; 
      width: calc(25% - 10px); /* Adjust width for 4 inputs in a row, approximately */
      box-sizing: border-box;
    }
    .settings-content-area .margin-group {
      display: flex;
      flex-wrap: wrap; /* Allow wrapping on small screens */
      gap: 5px; /* Space between margin inputs */
      align-items: center;
    }
    .settings-content-area .margin-group input[type="number"] {
      width: calc(50% - 10px); /* Two inputs per row in margin group */
      margin-right: 0;
    }
    .settings-content-area .margin-group span {
      margin-right: 5px;
      margin-bottom: 10px; /* Align with input margin */
    }
    .settings-content-area br { display: none; } /* Hide <br> tags if not needed */

    .settings-content-area .settings-actions { 
      margin-top: 10px; 
      display: flex; 
      flex-direction: column; /* Stack action buttons */
      gap: 10px; 
    }
    .settings-content-area .settings-actions .btn {
      width: 100%; /* Full width for settings action buttons */
    }

    .container { 
      width: 100%; 
      max-width: 900px; 
      margin: 0 auto; 
      background: #34495e; 
      padding: 15px; 
      box-sizing: border-box;
    }
    
    .main-content-area {
        /* Wraps scrollable parts */
    }

    .container > h2 { 
      display: none; 
    }
    h3 { 
      margin-top: 0; 
      border-bottom: 1px solid #4a6fa5; 
      padding-bottom: 8px;
      font-size: 1.25em;
    }

    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 2000;
    }
    .dialog-overlay.hidden {
        display: none;
    }
    .dialog-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #34495e;
        border: 1px solid #4a6fa5;
        border-radius: 8px;
        z-index: 2010;
        box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        width: 90%;
        max-width: 500px; 
        max-height: 80vh; 
        display: flex; 
        flex-direction: column;
    }
    .dialog-modal.hidden {
        display: none;
    }
    .dialog-content {
        padding: 20px;
        overflow-y: auto; 
        flex-grow: 1; 
    }
    .dialog-close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #5d8aa8;
        color: #ecf0f1;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 1.2em;
        line-height: 30px; 
        text-align: center;
        cursor: pointer;
    }
    .dialog-close-btn:hover {
        background: #4a6fa5;
    }

    .search-box { 
      background: #4a6fa5; 
      padding: 15px; 
      border-radius: 6px; 
      margin-bottom: 20px; 
      position: relative; 
    }
    .search-box input { 
      width: 100%; 
      padding: 12px;
      background: #2c3e50; 
      color: #ecf0f1; 
      border: 1px solid #5d8aa8; 
      border-radius: 4px; 
      box-sizing: border-box;
    }
    .suggestions { 
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0; 
      background: #34495e; 
      border: 1px solid #5d8aa8; 
      border-top: none; 
      border-radius: 0 0 4px 4px; 
      max-height: 200px; 
      overflow-y: auto; 
      display: none; 
      z-index: 10; 
    }
    .suggestion { 
      padding: 10px;
      cursor: pointer; 
      font-size: 0.9em; 
    }
    .suggestion:hover { background: #4a6fa5; }
    .suggestion.active { background: #2980b9; }
    .suggestion .lp-icon { 
      color: #2ecc71; 
      margin-left: 4px; 
      font-weight: bold; 
    }
    .preview-container { 
      margin-bottom: 20px; 
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .iframe-preview { 
      border: 1px solid #5d8aa8;
      width: 100%; 
      max-width: 300px;
    }
    
    #appFooter {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #34495e; 
      padding: 10px 15px;
      border-top: 1px solid #4a6fa5;
      z-index: 1000;
      display: flex;
      justify-content: flex-end; 
      box-sizing: border-box;
    }

    #appFooter .btn { 
       width: auto; 
    }

    .btn { 
      padding: 12px 15px;
      background: #5d8aa8; 
      color: #ecf0f1; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      transition: background .3s; 
      text-align: center;
      box-sizing: border-box;
    }
    .btn:hover { background: #4a6fa5; }
    
    #labelSettingsDialog .settings label, 
    #contentFiltersDialog .settings label { 
      display: block;
      width: auto;
      margin-bottom: 8px;
    }
     #labelSettingsDialog .settings input[type="number"],
     #contentFiltersDialog .settings input[type="number"] { 
      margin-right: 5px; 
      margin-bottom: 10px; 
      padding: 8px;
      border-radius: 4px; 
      border: 1px solid #5d8aa8; 
      background: #2c3e50; 
      color: #ecf0f1; 
      width: calc(25% - 10px);
      box-sizing: border-box;
    }
    #labelSettingsDialog .settings .margin-group,
    #contentFiltersDialog .settings .margin-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }
    #labelSettingsDialog .settings .margin-group input[type="number"],
    #contentFiltersDialog .settings .margin-group input[type="number"] {
      width: calc(50% - 10px);
      margin-right: 0;
    }
    #labelSettingsDialog .settings .margin-group span,
    #contentFiltersDialog .settings .margin-group span {
      margin-right: 5px;
      margin-bottom: 10px;
    }
    #labelSettingsDialog .settings br,
    #contentFiltersDialog .settings br { 
      display: none; 
    } 

    #labelSettingsDialog .settings .settings-actions,
    #contentFiltersDialog .settings .settings-actions { 
      margin-top: 10px; 
      display: flex; 
      flex-direction: column;
      gap: 10px; 
    }
    #labelSettingsDialog .settings .settings-actions .btn,
    #contentFiltersDialog .settings .settings-actions .btn {
      width: 100%; 
    }

    .settings-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #4a6fa5;
    }
    .filter-group {
      margin-bottom: 15px;
    }
    .filter-group h4 {
      font-size: 1.1em;
      margin-bottom: 8px;
      border-bottom: none;
    }
    .filter-controls {
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
    }
    .btn-small {
      padding: 5px 10px;
      font-size: 0.85em;
      width: auto;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      max-height: 150px;
      overflow-y: auto;
      background: #2c3e50;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #5d8aa8;
    }
    .checkbox-group label {
      display: block;
      color: #ecf0f1;
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
      vertical-align: middle;
    }

    /* Tablet Styles */
    @media (min-width: 600px) {
      body {
        /* padding: 20px; Is overridden by padding-top/bottom if they are static */
        padding-top: 60px; /* Adjust for potentially taller header */
        padding-bottom: 60px; /* Adjust for potentially taller footer */
      }
      .fixed-header { height: 60px; }
      .fixed-header h1 { font-size: 1.35em; }
      .fixed-footer { height: 60px; }
      
      .container {
        width: 90%; 
        padding: 20px;
        border-radius: 8px; 
        box-shadow: 0 0 10px rgba(0,0,0,0.5); 
      }
      #appTitle {
        font-size: 1.65em; 
      }
      /* General h2, h3 in container are fine */
      /* .buttons styling will be removed/adjusted later */
      /* .btn general styling is fine */

      .settings-content-area label {
        display: inline-block; /* Labels inline with inputs */
        width: 150px; /* Adjusted width for labels */
        margin-bottom: 5px;
      }
      .settings-content-area input[type="number"] {
        width: 70px; /* Slightly larger inputs */
      }
      .settings-content-area .margin-group {
        display: inline-block; /* Keep margin inputs inline */
      }
      .settings-content-area .margin-group input[type="number"] {
        width: 60px; /* Adjust width for margin inputs */
        margin-right: 1px;
      }
      .settings-content-area br { display: block; } /* Restore <br> visibility */

      .settings-content-area .settings-actions {
        flex-direction: row; /* Action buttons side-by-side */
        justify-content: flex-start;
        gap: 10px;
      }
      .settings-content-area .settings-actions .btn {
        width: auto; /* Auto width for settings action buttons */
      }
      .iframe-preview {
        max-width: 400px; 
      }
    }

    /* Desktop Styles */
    @media (min-width: 992px) {
      .container {
        max-width: 900px; 
      }
      .fixed-header h1 { font-size: 1.5em; }
      /* General h2, h3 in container are fine */
      .dialog-modal h3 { font-size: 1.3em; } /* Example specific style for dialog titles */

      .settings-content-area label {
        width: 120px; /* Original label width */
      }
      .settings-content-area input[type="number"] {
        width: 60px; /* Original input width */
      }
      .settings-content-area .margin-group input[type="number"] {
        width: 50px; /* Original margin input width */
      }
      .iframe-preview {
         max-width: 500px; 
      }
    }
  </style>
</head>
<body>
  <header id="appHeader">
    <span id="appTitle">KDM Label Printer</span>
    <button id="menuBtn" class="btn">☰</button>
  </header>

  <div id="mainMenu" class="menu-panel hidden">
    <ul class="menu-item-list">
      <li><a href="#" id="openLabelSettingsBtn" class="menu-link-item">Label Settings</a></li>
      <li><a href="#" id="openContentFiltersBtn" class="menu-link-item">Content Filters</a></li>
    </ul>
  </div>

  <div class="container">
    <div class="main-content-area"> 
      <div class="search-box">
        <h3>Search</h3>
        <input id="search" type="text" placeholder="Type item name..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <div id="list" class="suggestions"></div>
      </div>

      <div class="preview-container">
        <h3>Label Preview</h3>
        <iframe id="preview" class="iframe-preview"></iframe>
      </div>
    </div>
  </div>

  <footer id="appFooter">
    <button id="print" class="btn">Print</button>
  </footer>

  <div id="dialogOverlay" class="dialog-overlay hidden"></div>

  <div id="labelSettingsDialog" class="dialog-modal hidden">
    <div class="dialog-content">
      <button class="dialog-close-btn" data-dialog-id="labelSettingsDialog">X</button>
      <h3>Label Settings</h3>
      <label>Label Size (W H):</label>
      <input id="width" type="number" value="50.8" step="0.1" title="Label Width"><span>mm</span>
      <input id="height" type="number" value="25.4" step="0.1" title="Label Height"><span>mm</span><br>
      
      <label>Margins (Top R B L):</label>
      <div class="margin-group" style="display: inline-block;">
          <input id="marginTop" type="number" value="1" step="0.1" title="Top Margin"><span>mm</span>
          <input id="marginRight" type="number" value="1" step="0.1" title="Right Margin"><span>mm</span>
          <input id="marginBottom" type="number" value="1" step="0.1" title="Bottom Margin"><span>mm</span>
          <input id="marginLeft" type="number" value="1" step="0.1" title="Left Margin"><span>mm</span>
      </div>
      <div class="settings-actions">
          <button id="save" class="btn">Save Settings</button>
          <button id="showCalibrationLabelBtn" class="btn">Show Calibration Label</button>
      </div>
    </div>
  </div>

  <div id="contentFiltersDialog" class="dialog-modal hidden">
    <div class="dialog-content">
      <button class="dialog-close-btn" data-dialog-id="contentFiltersDialog">X</button>
      <div class="settings-section" id="contentFiltersInDialog"> 
        <h3>Content Filters</h3>
        <div class="filter-group" id="expansionFilters">
          <h4>Expansions</h4>
          <div class="filter-controls">
            <button id="selectAllExpansions" class="btn btn-small">Select All</button>
            <button id="deselectAllExpansions" class="btn btn-small">Deselect All</button>
          </div>
          <div id="expansionCheckboxes" class="checkbox-group">
            <!-- JS will populate -->
          </div>
        </div>
        <div class="filter-group" id="philosophyFilters">
          <h4>Philosophies</h4>
          <div class="filter-controls">
            <button id="selectAllPhilosophies" class="btn btn-small">Select All</button>
            <button id="deselectAllPhilosophies" class="btn btn-small">Deselect All</button>
          </div>
          <div id="philosophyCheckboxes" class="checkbox-group">
            <!-- JS will populate -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="./kdm-data.js"></script>
  <script>
    // Global-like variables for filter functionality
// These will be assigned their DOM elements once the DOM is loaded.
let expansionCheckboxesContainer, philosophyCheckboxesContainer;
const CORE_GAME_EXPANSION_NAME = "Core Game";

// Helper function to check if a filter is active from localStorage
function isFilterActive(type, name) {
  const storageKey = `filter_${type}_${name.replace(/\s+/g, '_')}`;
  const storedValue = localStorage.getItem(storageKey);
  return storedValue === null || storedValue === 'true'; // Default to true (selected)
}

// Debounce function
const debounce = (fn, delay = 300) => {
  let timeoutId;
  return (...args) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => fn(...args), delay);
  };
};

document.addEventListener('DOMContentLoaded', function() {
  // UI Element Variables
  const searchInput = document.getElementById('search');
  const suggestionBox = document.getElementById('list');
  const previewFrame = document.getElementById('preview');
  const printBtn = document.getElementById('print');

  // Elements within Label Settings Dialog (even though dialogs aren't fully functional yet, IDs are there)
  const saveBtn = document.getElementById('save');
  const widthInput = document.getElementById('width');
  const heightInput = document.getElementById('height');
  const marginTopInput = document.getElementById('marginTop');
  const marginRightInput = document.getElementById('marginRight');
  const marginBottomInput = document.getElementById('marginBottom');
  const marginLeftInput = document.getElementById('marginLeft');
  const showCalibrationLabelBtn = document.getElementById('showCalibrationLabelBtn');

  const menuBtn = document.getElementById('menuBtn');
  const mainMenu = document.getElementById('mainMenu'); // This is the panel with menu item links

  // Dialog related elements (for future use in next step, ensure IDs are correct in HTML)
  // const openLabelSettingsBtn = document.getElementById('openLabelSettingsBtn');
  // const openContentFiltersBtn = document.getElementById('openContentFiltersBtn');
  // const labelSettingsDialog = document.getElementById('labelSettingsDialog');
  // const contentFiltersDialog = document.getElementById('contentFiltersDialog');
  // const dialogOverlay = document.getElementById('dialogOverlay');
  // const closeDialogBtns = document.querySelectorAll('.dialog-close-btn');

  // Assign DOM elements for filter containers here (these are inside contentFiltersDialog)
  expansionCheckboxesContainer = document.getElementById('expansionCheckboxes');
  philosophyCheckboxesContainer = document.getElementById('philosophyCheckboxes');

  const selectAllExpansionsBtn = document.getElementById('selectAllExpansions');
  const deselectAllExpansionsBtn = document.getElementById('deselectAllExpansions');
  const selectAllPhilosophiesBtn = document.getElementById('selectAllPhilosophies');
  const deselectAllPhilosophiesBtn = document.getElementById('deselectAllPhilosophies');

  const romanNumeralRegex = /\s+(I|II|III)$/;
  const philosophyKnowledgeMap = { "The First Step": "Path of the First Step", "The Second Step": "Path of the Second Step", "The Third Step": "Path of the Third Step" };

  let defaultSettings = {
      width: 50.8, height: 25.4,
      marginTop: 1, marginRight: 1, marginBottom: 1, marginLeft: 1,
      unit: 'mm'
  };
  let loadedSettings = JSON.parse(localStorage.getItem('labelSettings'));
  let settings = { ...defaultSettings };

  if (loadedSettings) {
      settings.width = loadedSettings.width !== undefined ? loadedSettings.width : defaultSettings.width;
      settings.height = loadedSettings.height !== undefined ? loadedSettings.height : defaultSettings.height;
      settings.unit = loadedSettings.unit || defaultSettings.unit;
      if (loadedSettings.margin !== undefined && typeof loadedSettings.margin === 'number') {
          const oldMargin = parseFloat(loadedSettings.margin);
          settings.marginTop = oldMargin; settings.marginRight = oldMargin; settings.marginBottom = oldMargin; settings.marginLeft = oldMargin;
      } else {
          settings.marginTop = loadedSettings.marginTop !== undefined ? loadedSettings.marginTop : defaultSettings.marginTop;
          settings.marginRight = loadedSettings.marginRight !== undefined ? loadedSettings.marginRight : defaultSettings.marginRight;
          settings.marginBottom = loadedSettings.marginBottom !== undefined ? loadedSettings.marginBottom : defaultSettings.marginBottom;
          settings.marginLeft = loadedSettings.marginLeft !== undefined ? loadedSettings.marginLeft : defaultSettings.marginLeft;
      }
  }

  if (widthInput) widthInput.value = settings.width;
  if (heightInput) heightInput.value = settings.height;
  if (marginTopInput) marginTopInput.value = settings.marginTop;
  if (marginRightInput) marginRightInput.value = settings.marginRight;
  if (marginBottomInput) marginBottomInput.value = settings.marginBottom;
  if (marginLeftInput) marginLeftInput.value = settings.marginLeft;

  let selectedIndex = -1;

  function updatePreviewSize() {
      if (previewFrame) {
        previewFrame.style.width = settings.width + settings.unit;
        previewFrame.style.height = settings.height + settings.unit;
      }
  }

  function search(query) {
    const trimmedQuery = query.trim().toLowerCase();

    if (!window.dataset || !Array.isArray(window.dataset)) {
      console.error("Dataset not loaded or is not an array.");
      return [];
    }

    const filterablePhilosophyNames = new Set();
    if (philosophyCheckboxesContainer) {
        const philosophyCheckboxes = philosophyCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
        philosophyCheckboxes.forEach(cb => filterablePhilosophyNames.add(cb.value));
    }

    return window.dataset.filter(item => {
      if (!item || typeof item.name !== 'string' || typeof item.type !== 'string') {
        return false;
      }

      const nameMatches = !trimmedQuery || item.name.toLowerCase().includes(trimmedQuery);
      if (!nameMatches && trimmedQuery) {
        return false;
      }

      let itemExpansionName = item.expansion && item.expansion.trim() !== "" ? item.expansion.trim() : CORE_GAME_EXPANSION_NAME;
      if (!isFilterActive('expansion', itemExpansionName)) {
        return false;
      }

      if (item.type === 'Philosophy') {
        if (!isFilterActive('philosophy', item.name.trim())) {
          return false;
        }
      } else if (item.type === 'Knowledge') {
        const linkedPhilosophy = item.philosophyLinked ? item.philosophyLinked.trim() : null;
        if (linkedPhilosophy && linkedPhilosophy !== "" && filterablePhilosophyNames.has(linkedPhilosophy)) {
          if (!isFilterActive('philosophy', linkedPhilosophy)) {
            return false;
          }
        }
      }
      return true;
    });
  }

  function renderSuggestions(filteredItems) {
      if (!suggestionBox || !searchInput) return;
      suggestionBox.innerHTML = '';
      selectedIndex = -1;

      const queryIsEmpty = searchInput.value.trim() === '';
      if (queryIsEmpty && (!filteredItems || filteredItems.length === (window.dataset ? window.dataset.length : 0))) {
          suggestionBox.style.display = 'none';
          return;
      }
      if (queryIsEmpty && filteredItems && filteredItems.length > 0 && filteredItems.length < (window.dataset ? window.dataset.length : 0) ){
         // Query is empty, but filters ARE active, so show the filtered list.
      } else if (queryIsEmpty){
          suggestionBox.style.display = 'none';
          return;
      }

      if (!filteredItems || filteredItems.length === 0) {
          const noResult = document.createElement('div');
          noResult.textContent = 'No matches found.';
          noResult.classList.add('suggestion');
          suggestionBox.appendChild(noResult);
      } else {
          const itemsToShow = filteredItems.slice(0, 50);
          itemsToShow.forEach(item => {
              if (!item || typeof item.name !== 'string' || typeof item.type !== 'string') {
                  return;
              }
              const div = document.createElement('div');
              div.classList.add('suggestion');

              let baseText = `${item.name} (${item.type})`;
              let iconHTML = '';

              if (item.type === 'Knowledge') {
                const philosophyName = philosophyKnowledgeMap[item.name.replace(romanNumeralRegex, '').trim()];
                if (philosophyName) baseText += ` (${philosophyName})`;
              }

              if (item.type === 'Knowledge') {
                  const levelMatch = item.name.match(romanNumeralRegex);
                  if (levelMatch) {
                      const baseName = item.name.replace(romanNumeralRegex, '').trim();
                      try {
                        const lastPrintedFullName = localStorage.getItem(`lastPrinted_${baseName}`);
                        if (lastPrintedFullName && lastPrintedFullName === item.name) {
                            iconHTML = '<span class="lp-icon">✓</span>';
                        }
                      } catch (e) { console.warn("LocalStorage access error in renderSuggestions:", e); }
                  }
              }
              div.innerHTML = baseText + iconHTML;

              div.addEventListener('click', () => {
                  selectItem(item);
              });
              suggestionBox.appendChild(div);
          });
      }
      suggestionBox.style.display = 'block';
  }

  function selectItem(item) {
      if (!previewFrame || !searchInput) { console.error("selectItem: previewFrame or searchInput missing."); return; }
      if (!item || typeof item.name === 'undefined') { console.error("selectItem: Invalid item.", item); return; }

      if (suggestionBox) { suggestionBox.style.display = 'none'; }
      searchInput.value = item.name;

      let tenetKnowledgeItemData = null;
      if (item.type === 'Philosophy' && item.tenetKnowledge && typeof window.dataset !== 'undefined') {
          const baseKnowledgeName = item.tenetKnowledge;
          let knowledgeToFetchFullName = null;
          try {
              const lastPrintedFull = localStorage.getItem(`lastPrinted_${baseKnowledgeName}`);
              if (lastPrintedFull) {
                  const lastPrintedItemExists = window.dataset.find(k => k.name === lastPrintedFull && k.type === 'Knowledge');
                  if (lastPrintedItemExists) knowledgeToFetchFullName = lastPrintedFull;
              }
          } catch(e) { console.warn("LocalStorage access error for tenetKnowledge:", e); }

          if (!knowledgeToFetchFullName) {
              const defaultLevelName = `${baseKnowledgeName} I`;
              const defaultLevelItem = window.dataset.find(k => k.name === defaultLevelName && k.type === 'Knowledge');
              if (defaultLevelItem) {
                  knowledgeToFetchFullName = defaultLevelName;
              } else {
                  const directMatchItem = window.dataset.find(k => k.name === baseKnowledgeName && k.type === 'Knowledge');
                  if (directMatchItem) knowledgeToFetchFullName = baseKnowledgeName;
              }
          }
          if (knowledgeToFetchFullName) {
              const fetchedData = window.dataset.find(k => k.name === knowledgeToFetchFullName && k.type === 'Knowledge');
              if (fetchedData) tenetKnowledgeItemData = JSON.parse(JSON.stringify(fetchedData));
          }
      }

      const dataForIframe = {
          item: JSON.parse(JSON.stringify(item)),
          settings: JSON.parse(JSON.stringify(settings)),
          tenetKnowledgeItem: tenetKnowledgeItemData
      };

      const iframeSrc = 'label_render.html';
      const targetOrigin = window.location.origin === 'null' || window.location.protocol === 'file:' ? '*' : window.location.origin;

      const postDataToIframe = () => {
          if (previewFrame.contentWindow) {
              previewFrame.contentWindow.postMessage(dataForIframe, targetOrigin);
          } else { console.error(`KDMLabels.html: previewFrame.contentWindow not ready.`);}
      };

      if (previewFrame.getAttribute('src') !== iframeSrc || (item.type === 'Philosophy' || item.type === 'Calibration')) {
          previewFrame.setAttribute('src', iframeSrc);
          previewFrame.onload = () => {
              if (previewFrame.getAttribute('src') === iframeSrc && previewFrame.contentWindow) {
                   postDataToIframe();
              }
              previewFrame.onload = null;
          };
      } else {
          postDataToIframe();
      }
  }

  function printLabel() {
      if (!previewFrame || !previewFrame.contentWindow || !searchInput) {
          console.error("[PRINT] Aborting: previewFrame, contentWindow, or searchInput missing.");
          return;
      }
      try {
          previewFrame.contentWindow.focus();
          previewFrame.contentWindow.print();
      } catch (e) {
          console.error("[PRINT] Error during print attempt:", e);
          alert("Print Error. Ensure you are running from a web server and the iframe content has fully loaded.");
      }

      const labelTitle = searchInput.value;
      if (labelTitle && window.dataset && Array.isArray(window.dataset)) {
          const currentItem = window.dataset.find(i => i.name === labelTitle);
          if (currentItem && currentItem.type === 'Knowledge') {
              const baseNameRegex = /\s+(I|II|III)$/;
              let baseName = labelTitle;
              if (baseNameRegex.test(labelTitle)) {
                  baseName = labelTitle.replace(baseNameRegex, '').trim();
              }
              try { localStorage.setItem(`lastPrinted_${baseName}`, labelTitle); }
              catch (e) { console.warn("LocalStorage error in printLabel:", e); }
          }
      }
  }

  // --- Content Filter Functions ---
  function populateExpansionFilters() {
      if (!window.dataset || !expansionCheckboxesContainer) return; // expansionCheckboxesContainer is now global-like
      const expansionNames = new Set([CORE_GAME_EXPANSION_NAME]);
      window.dataset.forEach(item => {
          if (item.expansion && typeof item.expansion === 'string' && item.expansion.trim() !== "") {
              expansionNames.add(item.expansion.trim());
          }
      });
      expansionCheckboxesContainer.innerHTML = '';
      expansionNames.forEach(name => {
          createFilterCheckbox(name, expansionCheckboxesContainer, 'expansion', `filter_expansion_${name.replace(/\s+/g, '_')}`);
      });
  }

  function populatePhilosophyFilters() {
      if (!window.dataset || !philosophyCheckboxesContainer) return; // philosophyCheckboxesContainer is now global-like
      const philosophyNames = new Set();
      window.dataset.forEach(item => {
          if (item.type === 'Philosophy' && item.name && typeof item.name === 'string' && item.name.trim() !== "") {
              philosophyNames.add(item.name.trim());
          }
      });
      philosophyCheckboxesContainer.innerHTML = '';
      philosophyNames.forEach(name => {
          createFilterCheckbox(name, philosophyCheckboxesContainer, 'philosophy', `filter_philosophy_${name.replace(/\s+/g, '_')}`);
      });
  }

  function createFilterCheckbox(name, container, type, storageKey) {
      const div = document.createElement('div');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `${type}_${name.replace(/\s+/g, '_')}`;
      checkbox.value = name;
      const storedValue = localStorage.getItem(storageKey);
      checkbox.checked = (storedValue === null || storedValue === 'true');

      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = name;

      checkbox.addEventListener('change', function() {
          localStorage.setItem(storageKey, this.checked);
          if(searchInput) {
            const currentQuery = searchInput.value;
            renderSuggestions(search(currentQuery));
          }
      });

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
  }

  function setupFilterControls() {
      if (selectAllExpansionsBtn) {
          selectAllExpansionsBtn.addEventListener('click', () => setAllCheckboxes(expansionCheckboxesContainer, true));
      }
      if (deselectAllExpansionsBtn) {
          deselectAllExpansionsBtn.addEventListener('click', () => setAllCheckboxes(expansionCheckboxesContainer, false));
      }
      if (selectAllPhilosophiesBtn) {
          selectAllPhilosophiesBtn.addEventListener('click', () => setAllCheckboxes(philosophyCheckboxesContainer, true));
      }
      if (deselectAllPhilosophiesBtn) {
          deselectAllPhilosophiesBtn.addEventListener('click', () => setAllCheckboxes(philosophyCheckboxesContainer, false));
      }
  }

  function setAllCheckboxes(container, isChecked) {
      if (!container) return;
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
          if (checkbox.checked !== isChecked) {
              checkbox.checked = isChecked;
              const event = new Event('change', { bubbles: true });
              checkbox.dispatchEvent(event);
          }
      });
  }
  // --- End Content Filter Functions ---

  // --- Event Listeners ---
  if (searchInput) {
    searchInput.addEventListener('input', debounce(e => {
        const results = search(e.target.value);
        renderSuggestions(results);
    }, 300));
    searchInput.addEventListener('focus', () => {
        searchInput.select();
        const results = search(searchInput.value);
        renderSuggestions(results);
    });
    searchInput.addEventListener('keydown', e => {
        if (!suggestionBox) return; const items = suggestionBox.querySelectorAll('.suggestion'); if (!items.length || suggestionBox.style.display === 'none') {selectedIndex = -1; return;}
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') e.preventDefault();
        if (e.key === 'ArrowDown') selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        else if (e.key === 'ArrowUp') selectedIndex = Math.max(selectedIndex - 1, 0);
        else if (e.key === 'Enter') { if (selectedIndex >= 0 && items[selectedIndex] && typeof items[selectedIndex].click === 'function') { if (items[selectedIndex].textContent !== 'No matches found.') items[selectedIndex].click(); } return; }
        else if (e.key === 'Escape') { suggestionBox.style.display = 'none'; selectedIndex = -1; return;}
        else return;
        items.forEach((el, idx) => el.classList.toggle('active', idx === selectedIndex));
        if (items[selectedIndex]) items[selectedIndex].scrollIntoView({ block: 'nearest' });
    });
  }

  document.addEventListener('click', (e) => {
      let clickedInsideMenuOrButton = (menuBtn && menuBtn.contains(e.target)) || (mainMenu && mainMenu.contains(e.target));

      // This part handles clicks outside of active elements to close them.
      // It's important to check if elements exist before trying to access their properties.
      if (suggestionBox && !suggestionBox.contains(e.target) && e.target !== searchInput) {
          suggestionBox.style.display = 'none';
      }
      if (mainMenu && !mainMenu.classList.contains('hidden') && !clickedInsideMenuOrButton) {
        let clickedInsideDialog = false;
        // Check if any dialog is currently open and if the click was inside it.
        // This assumes dialogOverlay, labelSettingsDialog, contentFiltersDialog are defined.
        if (dialogOverlay && !dialogOverlay.classList.contains('hidden')) {
            if (labelSettingsDialog && !labelSettingsDialog.classList.contains('hidden') && labelSettingsDialog.contains(e.target)) clickedInsideDialog = true;
            if (contentFiltersDialog && !contentFiltersDialog.classList.contains('hidden') && contentFiltersDialog.contains(e.target)) clickedInsideDialog = true;
            if (e.target === dialogOverlay) clickedInsideDialog = true;
        }
        if(!clickedInsideDialog) mainMenu.classList.add('hidden');
      }
  });

  if (printBtn) { printBtn.addEventListener('click', printLabel); }

  // This is the main menu toggle
  if (menuBtn && mainMenu) {
    menuBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      mainMenu.classList.toggle('hidden');
    });
  }

  // Event listeners for Label Settings save and calibration (ensure these elements exist)
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
        if (widthInput) settings.width = parseFloat(widthInput.value);
        if (heightInput) settings.height = parseFloat(heightInput.value);
        if (marginTopInput) settings.marginTop = parseFloat(marginTopInput.value);
        if (marginRightInput) settings.marginRight = parseFloat(marginRightInput.value);
        if (marginBottomInput) settings.marginBottom = parseFloat(marginBottomInput.value);
        if (marginLeftInput) settings.marginLeft = parseFloat(marginLeftInput.value);
        localStorage.setItem('labelSettings', JSON.stringify(settings));
        updatePreviewSize();

        const currentSelectedItemName = searchInput ? searchInput.value : "";
        let itemToReselect = null;
        if (currentSelectedItemName === "--- PRINT CALIBRATION LABEL ---") {
             itemToReselect = { name: "--- PRINT CALIBRATION LABEL ---", type: "Calibration" };
        } else if (currentSelectedItemName && window.dataset) {
            itemToReselect = window.dataset.find(i => i.name === currentSelectedItemName);
        }
        if (itemToReselect) { selectItem(itemToReselect); }
    });
  }
  if (showCalibrationLabelBtn) {
      showCalibrationLabelBtn.addEventListener('click', function() {
          const calibrationItem = { name: "--- PRINT CALIBRATION LABEL ---", type: "Calibration" };
          selectItem(calibrationItem);
      });
  }

  // Initial Population and Setup for filters
  // Ensure these containers are valid before calling population functions
  if (expansionCheckboxesContainer && philosophyCheckboxesContainer) {
      populateExpansionFilters();
      populatePhilosophyFilters();
      setupFilterControls();
  } else {
      // It's possible these elements are not in the DOM if this script runs before dialog HTML is injected
      // or if the dialogs are not yet part of the main page structure this script expects.
      // console.error("Filter checkbox containers not found during DOMContentLoaded. Ensure HTML is correct.");
  }

  updatePreviewSize(); // Initial call
  // Perform an initial search to apply default filters (everything on)
  if (searchInput) { // Make sure searchInput exists
    const initialResults = search(searchInput.value);
    renderSuggestions(initialResults);
  }
});
  </script>
</body>
</html>