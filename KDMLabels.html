<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KDM Label Printer</title>
  <style>
    body { margin:0; padding:20px; font-family:Arial,sans-serif; background:#2c3e50; color:#ecf0f1; }
    .container { max-width:900px; margin:0 auto; background:#34495e; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.5); }
    h2, h3 { margin-top:0; border-bottom:1px solid #4a6fa5; padding-bottom:5px; }
    .search-box, .settings { background:#4a6fa5; padding:15px; border-radius:6px; margin-bottom:20px; position:relative; }
    .search-box input { width:100%; padding:10px; background:#2c3e50; color:#ecf0f1; border:1px solid #5d8aa8; border-radius:4px; }
    .suggestions { position:absolute; top:100%; left:0; right:0; background:#34495e; border:1px solid #5d8aa8; border-top:none; border-radius:0 0 4px 4px; max-height:200px; overflow-y:auto; display:none; z-index:10; }
    .suggestion { padding:8px; cursor:pointer; font-size: 0.9em; }
    .suggestion:hover { background:#4a6fa5; }
    .suggestion.active { background: #2980b9; }
    .suggestion .lp-icon { /* Style for the Last Printed icon */
        color: #2ecc71; /* Green checkmark */
        margin-left: 4px;
        font-weight: bold;
    }
    .preview-container { margin-bottom:20px; }
    .iframe-preview { border:none; }
    .buttons { text-align:right; margin-top:10px; display: flex; justify-content: flex-end; gap: 5px;}
    .btn { padding:8px 12px; background:#5d8aa8; color:#ecf0f1; border:none; border-radius:4px; cursor:pointer; transition:background .3s; }
    .btn:hover { background:#4a6fa5; }
    .settings.hidden { display:none; }
    .settings label { display:inline-block; width:120px; margin-bottom: 5px; }
    .settings input[type="number"] { margin-right:3px; margin-bottom:10px; padding:5px; border-radius:4px; border:1px solid #5d8aa8; background:#2c3e50; color:#ecf0f1; width:60px; }
    .settings .margin-group input[type="number"] { margin-right: 1px; width: 50px;}
    .settings .margin-group span { margin-right: 5px;}
    .settings .settings-actions { margin-top: 10px; display: flex; justify-content: flex-start; gap: 5px; } 
  </style>
</head>
<body>
  <div class="container">
    <h2>KDM Label Printer</h2>

    <div class="search-box">
      <h3>Search</h3>
      <input id="search" type="text" placeholder="Type item name..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <div id="list" class="suggestions"></div>
    </div>

    <div class="preview-container">
      <h3>Label Preview</h3>
      <iframe id="preview" class="iframe-preview"></iframe>
    </div>

    <div class="buttons">
      <button id="print" class="btn">Print</button>
      <button id="toggleSettings" class="btn">Settings</button>
    </div>

    <div id="settings" class="settings hidden">
      <h3>Label Settings</h3>
      <label>Label Size (W H):</label>
      <input id="width" type="number" value="50.8" step="0.1" title="Label Width"><span>mm</span>
      <input id="height" type="number" value="25.4" step="0.1" title="Label Height"><span>mm</span><br>
      
      <label>Margins (Top R B L):</label>
      <div class="margin-group" style="display: inline-block;">
          <input id="marginTop" type="number" value="1" step="0.1" title="Top Margin"><span>mm</span>
          <input id="marginRight" type="number" value="1" step="0.1" title="Right Margin"><span>mm</span>
          <input id="marginBottom" type="number" value="1" step="0.1" title="Bottom Margin"><span>mm</span>
          <input id="marginLeft" type="number" value="1" step="0.1" title="Left Margin"><span>mm</span>
      </div>
      <div class="settings-actions">
          <button id="save" class="btn">Save Settings</button>
          <button id="showCalibrationLabelBtn" class="btn">Show Calibration Label</button>
      </div>
    </div>
  </div>
<script src="./kdm-data.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('search');
      const suggestionBox = document.getElementById('list');
      const previewFrame = document.getElementById('preview');
      const printBtn = document.getElementById('print');
      const toggleSettingsBtn = document.getElementById('toggleSettings');
      // const generateAllBtn = document.getElementById('generateAllBtn'); // Removed
      const settingsPanel = document.getElementById('settings');
      const saveBtn = document.getElementById('save');
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      const marginTopInput = document.getElementById('marginTop');
      const marginRightInput = document.getElementById('marginRight');
      const marginBottomInput = document.getElementById('marginBottom');
      const marginLeftInput = document.getElementById('marginLeft');
      const showCalibrationLabelBtn = document.getElementById('showCalibrationLabelBtn');

      const romanNumeralRegex = /\s+(I|II|III)$/; 
      const philosophyKnowledgeMap = { "The First Step": "Path of the First Step", "The Second Step": "Path of the Second Step", "The Third Step": "Path of the Third Step" };

      let defaultSettings = {
          width: 50.8, height: 25.4,
          marginTop: 1, marginRight: 1, marginBottom: 1, marginLeft: 1,
          unit: 'mm'
      };
      let loadedSettings = JSON.parse(localStorage.getItem('labelSettings'));
      let settings = { ...defaultSettings };
      if (loadedSettings) {
          settings.width = loadedSettings.width !== undefined ? loadedSettings.width : defaultSettings.width;
          settings.height = loadedSettings.height !== undefined ? loadedSettings.height : defaultSettings.height;
          settings.unit = loadedSettings.unit || defaultSettings.unit;
          if (loadedSettings.margin !== undefined && typeof loadedSettings.margin === 'number') { 
              const oldMargin = parseFloat(loadedSettings.margin);
              settings.marginTop = oldMargin; settings.marginRight = oldMargin; settings.marginBottom = oldMargin; settings.marginLeft = oldMargin;
          } else {
              settings.marginTop = loadedSettings.marginTop !== undefined ? loadedSettings.marginTop : defaultSettings.marginTop;
              settings.marginRight = loadedSettings.marginRight !== undefined ? loadedSettings.marginRight : defaultSettings.marginRight;
              settings.marginBottom = loadedSettings.marginBottom !== undefined ? loadedSettings.marginBottom : defaultSettings.marginBottom;
              settings.marginLeft = loadedSettings.marginLeft !== undefined ? loadedSettings.marginLeft : defaultSettings.marginLeft;
          }
      }
      
      if (widthInput) widthInput.value = settings.width;
      if (heightInput) heightInput.value = settings.height;
      if (marginTopInput) marginTopInput.value = settings.marginTop;
      if (marginRightInput) marginRightInput.value = settings.marginRight;
      if (marginBottomInput) marginBottomInput.value = settings.marginBottom;
      if (marginLeftInput) marginLeftInput.value = settings.marginLeft;

      let selectedIndex = -1;
      
      const debounce = (fn, delay = 300) => {
          let timeoutId;
          return (...args) => {
              clearTimeout(timeoutId);
              timeoutId = setTimeout(() => fn(...args), delay);
          };
      };

      function updatePreviewSize() {
          if (previewFrame) { 
            previewFrame.style.width = settings.width + settings.unit;
            previewFrame.style.height = settings.height + settings.unit;
          }
      }

      function search(query) {
          const trimmedQuery = query.trim().toLowerCase();
          if (!trimmedQuery) return [];
          if (!window.dataset || !Array.isArray(window.dataset)) {
              console.error("Dataset not loaded or is not an array.");
              return [];
          }
          return window.dataset.filter(item => item && item.name && typeof item.name === 'string' && item.name.toLowerCase().includes(trimmedQuery));
      }
      
      function renderSuggestions(filteredItems) {
          if (!suggestionBox || !searchInput) return; 
          suggestionBox.innerHTML = ''; 
          selectedIndex = -1; 
          if (searchInput.value.trim() === '') {
              suggestionBox.style.display = 'none';
              return;
          }

          if (!filteredItems || filteredItems.length === 0) {
              const noResult = document.createElement('div');
              noResult.textContent = 'No matches found.';
              noResult.classList.add('suggestion'); 
              suggestionBox.appendChild(noResult);
          } else {
              const itemsToShow = filteredItems.slice(0, 50);
              itemsToShow.forEach(item => {
                  if (!item || typeof item.name !== 'string' || typeof item.type !== 'string') {
                      return; 
                  }
                  const div = document.createElement('div');
                  div.classList.add('suggestion');
                  
                  let baseText = `${item.name} (${item.type})`;
                  let iconHTML = ''; 

                  if (item.type === 'Knowledge') {
                    const philosophyName = philosophyKnowledgeMap[item.name.replace(romanNumeralRegex, '').trim()];
                    if (philosophyName) baseText += ` (${philosophyName})`;
                  }

                  if (item.type === 'Knowledge') {
                      const levelMatch = item.name.match(romanNumeralRegex); 
                      if (levelMatch) { 
                          const baseName = item.name.replace(romanNumeralRegex, '').trim();
                          try {
                            const lastPrintedFullName = localStorage.getItem(`lastPrinted_${baseName}`);
                            if (lastPrintedFullName && lastPrintedFullName === item.name) {
                                iconHTML = '<span class="lp-icon">✓</span>'; 
                            }
                          } catch (e) { console.warn("LocalStorage access error in renderSuggestions:", e); }
                      }
                  }
                  div.innerHTML = baseText + iconHTML; 
                  
                  div.addEventListener('click', () => {
                      selectItem(item);
                  });
                  suggestionBox.appendChild(div);
              });
          }
          suggestionBox.style.display = 'block';
      }

    function selectItem(item) { // Removed isRenderAllAction parameter
        if (!previewFrame || !searchInput) { console.error("selectItem: previewFrame or searchInput missing."); return; }
        if (!item || typeof item.name === 'undefined') { console.error("selectItem: Invalid item.", item); return; }
        
        if (suggestionBox) { suggestionBox.style.display = 'none'; }
        searchInput.value = item.name;

        let tenetKnowledgeItemData = null;
        if (item.type === 'Philosophy' && item.tenetKnowledge && typeof window.dataset !== 'undefined') {
            const baseKnowledgeName = item.tenetKnowledge; 
            let knowledgeToFetchFullName = null;
            try {
                const lastPrintedFull = localStorage.getItem(`lastPrinted_${baseKnowledgeName}`);
                if (lastPrintedFull) {
                    const lastPrintedItemExists = window.dataset.find(k => k.name === lastPrintedFull && k.type === 'Knowledge');
                    if (lastPrintedItemExists) knowledgeToFetchFullName = lastPrintedFull;
                }
            } catch(e) { console.warn("LocalStorage access error for tenetKnowledge:", e); }
            
            if (!knowledgeToFetchFullName) {
                const defaultLevelName = `${baseKnowledgeName} I`;
                const defaultLevelItem = window.dataset.find(k => k.name === defaultLevelName && k.type === 'Knowledge');
                if (defaultLevelItem) {
                    knowledgeToFetchFullName = defaultLevelName;
                } else {
                    const directMatchItem = window.dataset.find(k => k.name === baseKnowledgeName && k.type === 'Knowledge');
                    if (directMatchItem) knowledgeToFetchFullName = baseKnowledgeName;
                }
            }
            if (knowledgeToFetchFullName) {
                const fetchedData = window.dataset.find(k => k.name === knowledgeToFetchFullName && k.type === 'Knowledge');
                if (fetchedData) tenetKnowledgeItemData = JSON.parse(JSON.stringify(fetchedData));
            }
        }

        const dataForIframe = {
            item: JSON.parse(JSON.stringify(item)), 
            settings: JSON.parse(JSON.stringify(settings)),
            tenetKnowledgeItem: tenetKnowledgeItemData 
        };
        // No 'action' or 'dataset' property for "renderAll" needed anymore
        
        const iframeSrc = 'label_render.html'; 
        const targetOrigin = window.location.origin === 'null' || window.location.protocol === 'file:' ? '*' : window.location.origin;
        
        const postDataToIframe = () => {
            if (previewFrame.contentWindow) {
                previewFrame.contentWindow.postMessage(dataForIframe, targetOrigin);
            } else { console.error(`KDMLabels.html: previewFrame.contentWindow not ready.`);}
        };

        if (previewFrame.getAttribute('src') !== iframeSrc || (item.type === 'Philosophy' || item.type === 'Calibration')) {
            previewFrame.setAttribute('src', iframeSrc); 
            previewFrame.onload = () => {
                if (previewFrame.getAttribute('src') === iframeSrc && previewFrame.contentWindow) { 
                     postDataToIframe(); 
                }
                previewFrame.onload = null; 
            };
        } else { 
            postDataToIframe(); 
        }
    }

    function printLabel() {
        if (!previewFrame || !previewFrame.contentWindow || !searchInput) { 
            console.error("[PRINT] Aborting: previewFrame, contentWindow, or searchInput missing.");
            return; 
        }
        try {
            previewFrame.contentWindow.focus();
            previewFrame.contentWindow.print();
        } catch (e) { 
            console.error("[PRINT] Error during print attempt:", e); 
            alert("Print Error. Ensure you are running from a web server and the iframe content has fully loaded.");
        }
        
        const labelTitle = searchInput.value; 
        if (labelTitle && window.dataset && Array.isArray(window.dataset)) {
            const currentItem = window.dataset.find(i => i.name === labelTitle);
            if (currentItem && currentItem.type === 'Knowledge') {
                const baseNameRegex = /\s+(I|II|III)$/; 
                let baseName = labelTitle;
                if (baseNameRegex.test(labelTitle)) {
                    baseName = labelTitle.replace(baseNameRegex, '').trim();
                }
                try { localStorage.setItem(`lastPrinted_${baseName}`, labelTitle); } 
                catch (e) { console.warn("LocalStorage error in printLabel:", e); }
            }
        }
    }

      // --- Event Listeners ---
      if (searchInput) {
        searchInput.addEventListener('input', debounce(e => {
            const results = search(e.target.value);
            renderSuggestions(results);
        }, 300));
        searchInput.addEventListener('focus', () => { searchInput.select(); });
        searchInput.addEventListener('keydown', e => { /* ... (standard keydown logic for suggestions) ... */ 
            if (!suggestionBox) return; const items = suggestionBox.querySelectorAll('.suggestion'); if (!items.length || suggestionBox.style.display === 'none') {selectedIndex = -1; return;}
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') e.preventDefault();
            if (e.key === 'ArrowDown') selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            else if (e.key === 'ArrowUp') selectedIndex = Math.max(selectedIndex - 1, 0);
            else if (e.key === 'Enter') { if (selectedIndex >= 0 && items[selectedIndex] && typeof items[selectedIndex].click === 'function') { if (items[selectedIndex].textContent !== 'No matches found.') items[selectedIndex].click(); } return; }
            else if (e.key === 'Escape') { suggestionBox.style.display = 'none'; selectedIndex = -1; return;}
            else return;
            items.forEach((el, idx) => el.classList.toggle('active', idx === selectedIndex));
            if (items[selectedIndex]) items[selectedIndex].scrollIntoView({ block: 'nearest' });
        });
      }
      document.addEventListener('click', (e) => {
          if (suggestionBox && searchInput && !suggestionBox.contains(e.target) && e.target !== searchInput) {
              suggestionBox.style.display = 'none';
          }
      });
      if (printBtn) { printBtn.addEventListener('click', printLabel); }
      if (toggleSettingsBtn) { 
        toggleSettingsBtn.addEventListener('click', () => {
            if (settingsPanel) settingsPanel.classList.toggle('hidden');
        });
      }
      if (saveBtn) { 
        saveBtn.addEventListener('click', () => {
            if (widthInput) settings.width = parseFloat(widthInput.value);
            if (heightInput) settings.height = parseFloat(heightInput.value);
            if (marginTopInput) settings.marginTop = parseFloat(marginTopInput.value);
            if (marginRightInput) settings.marginRight = parseFloat(marginRightInput.value);
            if (marginBottomInput) settings.marginBottom = parseFloat(marginBottomInput.value);
            if (marginLeftInput) settings.marginLeft = parseFloat(marginLeftInput.value);
            localStorage.setItem('labelSettings', JSON.stringify(settings));
            updatePreviewSize();
            const currentSelectedItemName = searchInput.value;
            let itemToReselect = null;
            if (currentSelectedItemName === "--- PRINT CALIBRATION LABEL ---") {
                 itemToReselect = { name: "--- PRINT CALIBRATION LABEL ---", type: "Calibration" };
            } else if (currentSelectedItemName && window.dataset) { 
                itemToReselect = window.dataset.find(i => i.name === currentSelectedItemName);
            }
            if (itemToReselect) { selectItem(itemToReselect); }
        }); 
      }
      if (showCalibrationLabelBtn) { 
          showCalibrationLabelBtn.addEventListener('click', function() {
              const calibrationItem = { name: "--- PRINT CALIBRATION LABEL ---", type: "Calibration" };
              selectItem(calibrationItem); 
          });
      }
      // Removed generateAllBtn listener
      updatePreviewSize();
    });
  </script>
</body>
</html>